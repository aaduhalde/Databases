 
 -- ver documento guia ORACLE,
 -- hacer una parte y calcular el tiempo restante
 -- imprimir un CASE con excepciones, 
 
 FUNCTION f_genera_csv_ecommerce(p_id_cursor   IN NUMBER,
                                 p_slc_reporte IN NUMBER,
                                 p_error_text  OUT VARCHAR2)
   --P_ID_CURSOR es el valor analizado para determinar que reporte debe armar
   RETURN NUMBER IS
    v_destinatarios  VARCHAR2(500);
    v_from           VARCHAR2(100);
    v_text           VARCHAR2(2000);
    v_dir            VARCHAR2(100);
    v_dir_path       VARCHAR2(100);
    v_nom_cur        VARCHAR2(1000);
    v_subject        VARCHAR2(100);
    v_result         NUMBER;
    v_datos          VARCHAR2(10) := 'S'; -- ESTA VARIABLE ES PARA DETERMINAR SI HAY DATOS
    OUT_FILE         UTL_FILE.FILE_TYPE;
    file_name        VARCHAR2(70);
    e_error          EXCEPTION;
    v_sentencia      VARCHAR2(100) := '';
    v_error          VARCHAR2(100) := NULL;
    v_header         VARCHAR2(5000) := NULL;

    v_fecha_desde DATE;
    v_fecha_hasta DATE;
    --ECOM-1188
    --parametros nuevos
    v_estados_cater Maveric_parameters.Mpr_Value%type:=null;
    v_estados_acti  Maveric_parameters.Mpr_Value%type:=null;
    v_oso_id_cater  Maveric_parameters.Mpr_Value%type:=null;
    v_razon_cater   Maveric_parameters.Mpr_Value%type:=null;
    v_oso_id_acti   Maveric_parameters.Mpr_Value%type:=null;
    v_dealer_acti   Maveric_parameters.Mpr_Value%type:=null;
    v_version       number(1):=1;
    v_fecha_comparacion_pp DATE;
    --ECOM-1188
  BEGIN
    v_datos := 'N';

    CASE P_ID_CURSOR
      WHEN 1 THEN

        BEGIN
          v_sentencia := 'Buscando WS_MAIL_TO...';
          SELECT MPR_VALUE
            INTO v_destinatarios
            FROM MAVERIC_PARAMETERS
           WHERE MPR_ID = 'WS_MAIL_TO';

          v_sentencia := 'Buscando WS_DIR_REPORTE...';
          SELECT MPR_VALUE
            INTO v_dir
            FROM MAVERIC_PARAMETERS
           WHERE MPR_ID = 'WS_DIR_REPORTE';

          v_sentencia := 'Buscando WS_MAIL_FROM...';
          SELECT MPR_VALUE
            INTO v_from
            FROM MAVERIC_PARAMETERS
           WHERE MPR_ID = 'WS_MAIL_FROM';
           ----
          v_sentencia := 'Obteniendo path real para WS_DIR_REPORTE';
          SELECT directory_path
            INTO v_dir_path
            FROM dba_directories
           WHERE upper(directory_name) =
                 (SELECT mpr_value
                    FROM maveric_parameters
                   WHERE mpr_id = 'WS_DIR_REPORTE');

          --ECOM-1188 Obtengo los parametros NUEVOS
          v_sentencia := 'Buscando PP WS_CHANGE_PP';

          BEGIN
          SELECT trunc(sysdate) - mpr_value
            INTO v_fecha_comparacion_pp
            FROM MAVERIC_PARAMETERS
           WHERE mpr_id = 'WS_CHANGE_PP';
          EXCEPTION
            WHEN NO_DATA_FOUND THEN
              v_fecha_comparacion_pp:=trunc(sysdate) - 180;
          END;

          v_sentencia := 'Buscando WS_STATUS_CATER';
          BEGIN
          select mpr_value
            into v_estados_cater
            from maveric_parameters
           where mpr_id = 'WS_STATUS_CATER';
          EXCEPTION
            WHEN NO_DATA_FOUND THEN
              v_estados_cater:='#177#519#';
          END;

          v_sentencia := 'Buscando WS_STATUS_ACTI';
          BEGIN
          select mpr_value
            into v_estados_acti
            from maveric_parameters
           where mpr_id = 'WS_STATUS_ACTI';
          EXCEPTION
            WHEN NO_DATA_FOUND THEN
              v_estados_acti:='#177#';
          END;

          v_sentencia := 'Buscando WS_OSO_ID_CATER';
          BEGIN
          select mpr_value
            into v_oso_id_cater
            from maveric_parameters
           where mpr_id = 'WS_OSO_ID_CATER';
          EXCEPTION
            WHEN NO_DATA_FOUND THEN
              v_oso_id_cater:='E1';
          END;

          v_sentencia := 'Buscando WS_RSN_PRODUCT';     --- ECOM-9853
          BEGIN
          select mpr_value
            into v_razon_cater
            from maveric_parameters
           where mpr_id = 'WS_RSN_PRODUCT';  --'WS_RAZON_EQUIPO'; --- ECOM-9853
          EXCEPTION
             WHEN NO_DATA_FOUND THEN
                 v_razon_cater:='$VENTER$VTACCE$';    ---ECOM-9853
          END;

          v_sentencia := 'Buscando WS_OSO_ID_ACTI';

          BEGIN
          select mpr_value
            into v_oso_id_acti
            from maveric_parameters
           where mpr_id = 'WS_OSO_ID_ACTI';
          EXCEPTION
            WHEN NO_DATA_FOUND THEN
              v_oso_id_acti:='VT';
          END;

          v_sentencia := 'Buscando WS_DEALER_ACTI ';

          BEGIN
          select mpr_value
            into v_dealer_acti
            from maveric_parameters
           where mpr_id = 'WS_DEALER_ACTI';
          EXCEPTION
            WHEN NO_DATA_FOUND THEN
              v_dealer_acti:='E-COM00000';
          END;
          v_sentencia := 'Buscando WS_VERSION_REP';

          BEGIN
          select mpr_value
            into v_version
            from maveric_parameters
           where mpr_id = 'WS_VERSION_REP';
          EXCEPTION
            WHEN NO_DATA_FOUND THEN
              v_version:=2;
          END;

          --Se selecciona el periodo en el que se toman los datos
          IF P_SLC_REPORTE = 1 THEN
            SELECT last_day(add_months(trunc(sysdate), -1)) + 1,
                   last_day(trunc(sysdate)) + 1
              INTO v_fecha_desde, v_fecha_hasta
              FROM dual;

            v_sentencia := 'Buscando WS_MAIL_TEXT1...';
            SELECT MPR_VALUE
              INTO v_text
              FROM MAVERIC_PARAMETERS
             WHERE MPR_ID = 'WS_MAIL_TEXT1';

            v_sentencia := 'Buscando WS_MAIL_SUBJ1...';
            SELECT MPR_VALUE
              INTO v_nom_cur
              FROM MAVERIC_PARAMETERS
             WHERE MPR_ID = 'WS_MAIL_SUBJ1';

            v_subject := v_nom_cur;
          END IF;

          IF P_SLC_REPORTE = 2 THEN
            SELECT last_day(add_months(trunc(sysdate), -2)) + 1,
                   last_day(add_months(trunc(sysdate), -1)) + 1
              INTO v_fecha_desde, v_fecha_hasta
              FROM dual;

            v_sentencia := 'Buscando WS_MAIL_TEXT2...';
            SELECT MPR_VALUE
              INTO v_text
              FROM MAVERIC_PARAMETERS
             WHERE MPR_ID = 'WS_MAIL_TEXT2';

            v_sentencia := 'Buscando WS_MAIL_SUBJ2...';
            SELECT MPR_VALUE
              INTO v_nom_cur
              FROM MAVERIC_PARAMETERS
             WHERE MPR_ID = 'WS_MAIL_SUBJ2';

            v_subject := v_nom_cur;
          END IF;

          IF P_SLC_REPORTE = 3 THEN
            SELECT TRUNC(SYSDATE),
                   trunc(sysdate+1)
              INTO v_fecha_desde, v_fecha_hasta
              FROM dual;

            v_sentencia := 'Buscando WS_MAIL_TEXT3...';
            SELECT 'Reporte del dia'
              INTO v_text
              FROM dual;

            v_sentencia := 'Buscando WS_MAIL_SUBJ3...';
            SELECT 'Reporte_dia_actual'
              INTO v_nom_cur
              FROM dual;

            v_subject := v_nom_cur;
          END IF;

        EXCEPTION
          WHEN NO_DATA_FOUND THEN
            p_error_text := 'No se encontro el parametro, ' || v_sentencia;
            RETURN 1;
          WHEN OTHERS THEN
            p_error_text := 'Error ' || SQLCODE || ' ' || SQLERRM;
            RETURN 1;
        END;

        v_sentencia := 'CREANDO ARCHIVO ' || v_nom_cur || '...';
        file_name   := v_nom_cur || to_char(SYSDATE,'yyyymmddhhmiss') || '.csv';
        OUT_FILE    := UTL_FILE.FOPEN(v_dir, file_name, 'W',32767);   --- ECOM-9853